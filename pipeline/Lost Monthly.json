{
	"name": "Lost Monthly",
	"properties": {
		"activities": [
			{
				"name": "update dashboard_category Lost",
				"type": "Copy",
				"dependsOn": [],
				"policy": {
					"timeout": "0.12:00:00",
					"retry": 0,
					"retryIntervalInSeconds": 30,
					"secureOutput": false,
					"secureInput": false
				},
				"userProperties": [],
				"typeProperties": {
					"source": {
						"type": "AzureSqlSource",
						"sqlReaderQuery": {
							"value": "WITH CTE AS (\r\n    SELECT \r\n        A.MemberGrade__c AS [Member Grade], \r\n        A.BillingGrade__c AS [Billing Grade], \r\n        B.Lostmembers AS ID  , \r\n\t\tB.DateStart as MonthDate, \r\n\t\tcategory='Lost'\r\n\t\t--update the Function here \r\n    FROM [membership].[members_Lost_A](@{pipeline().parameters.Month}) B\r\n    INNER JOIN [salesforce].[Account] A ON B.Lostmembers = A.id\r\n),\r\nCTE1 AS (\r\n    SELECT \r\n        CTE.*, \r\n        CASE    \r\n            WHEN [Member Grade] IN ('Member', 'Senior Member', 'Fellow', 'Honorary Fellow') THEN 'Professional'    \r\n            WHEN [Member Grade] = 'Associate' AND [Billing Grade] IN (    \r\n                '1 - Continuing', '3 - Full Fee', '5 - Life Member',    \r\n                '2 - PPP Full Fee', '3 - Full Fee', '17 - PPP MOU2',    \r\n                '8 - Retired'  \r\n            ) THEN 'Full Fee Associates'    \r\n            WHEN [Member Grade] NOT IN ('Member', 'Senior Member', 'Fellow', 'Honorary Fellow', 'Subscriber', 'Honorary Member')    \r\n                AND [Billing Grade] IN (    \r\n                    '4 - Graduate - 1st Year', '7 - Graduate - 2nd Year',    \r\n                    '10 - Student - PPP', '11 - Student',    \r\n                    '15 - Student - ACSF', '16 - Unemployed / On Hiatus'    \r\n                ) THEN 'Discounted (Full Benefits)'    \r\n            WHEN [Member Grade] NOT IN ('Member', 'Senior Member', 'Fellow', 'Honorary Fellow', 'Subscriber', 'Honorary Member')   \r\n                AND [Billing Grade] IN ('20 - Skills Applicant') THEN 'Skills Applicants'  \r\n            WHEN [Member Grade] NOT IN ('Member', 'Senior Member', 'Fellow', 'Honorary Fellow', 'Subscriber', 'Honorary Member')  \r\n                AND [Billing Grade] IN ('11 - Complimentary', '12 - Complimentary', '13 - Honoured') THEN 'Complimentary (Full Benefits)'  \r\n            WHEN [Member Grade] NOT IN ('Member', 'Senior Member', 'Fellow', 'Honorary Fellow', 'Subscriber', 'Honorary Member')  \r\n                AND [Billing Grade] IN ('14 - Student - PYear') THEN 'Professional Year'  \r\n            WHEN [Member Grade] NOT IN ('Member', 'Senior Member', 'Fellow', 'Honorary Fellow', 'Subscriber', 'Honorary Member')   \r\n                AND [Billing Grade] IN (\r\n                    '18 - Digital Subscriber', '19 - Subscriber - PPP', '18 - Subscriber - PPP'    \r\n                ) THEN 'Subscribers (Discounted Limited Benefits)'\r\n            ELSE NULL -- Set Heirarchy to NULL if none of the conditions are met\r\n        END AS Heirarchy\r\n    FROM CTE\r\n), \r\nCTE2 \r\nAs (\r\n\r\nSELECT *, \r\n    CASE  \r\n        WHEN [Heirarchy] = 'Professional' AND [Billing Grade] NOT IN ('5 - Life Member', '13 - Honoured', '1 - Continuing', '8 - Retired', '3 - Full Fee', '2 - PPP Full Fee', '17 - PPP MOU2', '16 - PPP MOU2') \r\n\t\tTHEN 'Member, Senior Member, Fellow'  \r\n   \r\n        WHEN [Heirarchy] = 'Professional' AND [Billing Grade] IN ('5 - Life Member', '13 - Honoured', '1 - Continuing') THEN 'Life Members, Hon Members'        \r\n        WHEN [Heirarchy] = 'Professional' AND [Billing Grade] = '3 - Full Fee' THEN 'Full Fee (Individual)'        \r\n        WHEN [Heirarchy] = 'Professional' AND [Billing Grade] IN ('2 - PPP Full Fee', '17 - PPP MOU2', '16 - PPP MOU2') THEN 'Full Fee (PPP)'        \r\n        WHEN [Heirarchy] = 'Professional' AND [Billing Grade] = '8 - Retired' THEN 'Retired'        \r\n  \r\n            \r\n        WHEN [Heirarchy] = 'Full Fee Associates' AND [Billing Grade] IN ('3 - Full Fee', '5 - Life Member', '1 - Continuing') THEN 'Full Fee Associates (Individual)'        \r\n        WHEN [Heirarchy] = 'Full Fee Associates' AND [Billing Grade] IN ('2 - PPP Full Fee', '17 - PPP MOU2', '16 - PPP MOU2') THEN 'Full Fee Associates (PPP)'        \r\n       WHEN [Heirarchy] = 'Full Fee Associates' AND [Billing Grade] = '8 - Retired' THEN 'Retired'     \r\n              \r\n        WHEN [Heirarchy] = 'Discounted\u000b(Full Benefits)' AND [Billing Grade] IN ('10 - Student - PPP', '11 - Student', '15 - Student - ACSF') THEN 'Students'        \r\n        WHEN [Heirarchy] = 'Discounted\u000b(Full Benefits)' AND [Billing Grade] IN ('4 - Graduate - 1st Year', '7 - Graduate - 2nd Year') THEN 'Graduate'        \r\n        WHEN [Heirarchy] = 'Discounted\u000b(Full Benefits)' AND [Billing Grade] = '16 - Unemployed / On Hiatus' THEN 'Unemployed'   \r\n  \r\n            \r\n        WHEN [Heirarchy] = 'Subscribers (Discounted Limited Benefits)' AND [Billing Grade] NOT IN ('19 - Subscriber - PPP', '18 - Subscriber - PPP') THEN 'Individuals'        \r\n        WHEN [Heirarchy] = 'Subscribers (Discounted Limited Benefits)' AND [Billing Grade] IN ('19 - Subscriber - PPP', '18 - Subscriber - PPP') THEN 'PPP'        \r\n        WHEN [Heirarchy] = 'Professional Year' THEN 'Professional Year'        \r\n        WHEN [Heirarchy] = 'Complimentary (Full Benefits)' THEN 'Complimentary'        \r\n        --WHEN [BGG] = 'Overseas' AND [Heirarchy] != 'Professional' THEN 'Skills Applicants'        \r\n        WHEN [Heirarchy] = 'Skills Applicants' THEN 'Skills Applicants'        \r\n        --WHEN ([subsegments] = 'Full Fee Associates (PPP)' OR [subsegments] = 'Full Fee Associates (Individual)') THEN 'Full Fee Associates'      \r\n    END as subsegments\r\nFROM CTE1)\r\nselect * from CTE2\r\n",
							"type": "Expression"
						},
						"queryTimeout": "02:00:00",
						"partitionOption": "None"
					},
					"sink": {
						"type": "AzureSqlSink",
						"preCopyScript": {
							"value": "delete from  [membership].[dashboard_category] where \nMonthdate = @{pipeline().parameters.Month}\nand category ='Lost'",
							"type": "Expression"
						},
						"writeBehavior": "insert",
						"sqlWriterUseTableLock": false,
						"disableMetricsCollection": false
					},
					"enableStaging": false,
					"translator": {
						"type": "TabularTranslator",
						"typeConversion": true,
						"typeConversionSettings": {
							"allowDataTruncation": true,
							"treatBooleanAsNumber": false
						}
					}
				},
				"inputs": [
					{
						"referenceName": "SQLTableQ",
						"type": "DatasetReference",
						"parameters": {
							"tablename": "Employees",
							"schemaname": "dbo"
						}
					}
				],
				"outputs": [
					{
						"referenceName": "SQLTableQ",
						"type": "DatasetReference",
						"parameters": {
							"tablename": "dashboard_category",
							"schemaname": "membership"
						}
					}
				]
			}
		],
		"parameters": {
			"Month": {
				"type": "string",
				"defaultValue": "'2024-01-31'"
			}
		},
		"folder": {
			"name": "ACS/Membership/Monthly"
		},
		"annotations": []
	}
}