{
	"name": "New Monthly",
	"properties": {
		"activities": [
			{
				"name": "update dashboard_category",
				"type": "Copy",
				"dependsOn": [],
				"policy": {
					"timeout": "0.12:00:00",
					"retry": 0,
					"retryIntervalInSeconds": 30,
					"secureOutput": false,
					"secureInput": false
				},
				"userProperties": [],
				"typeProperties": {
					"source": {
						"type": "AzureSqlSource",
						"sqlReaderQuery": "WITH CTE AS (\n    SELECT \n        A.MemberGrade__c AS [Member Grade], \n        A.BillingGrade__c AS [Billing Grade], \n        B.NewMembers AS ID  , \n\t\tB.DateStart as MonthDate, \n\t\tcategory='New'\n\t\t--update the Function here \n    FROM [membership].[members_new12month_A](@{pipeline().parameters.Month}) B\n    INNER JOIN [salesforce].[Account] A ON B.NewMembers = A.id\n),\nCTE1 AS (\n    SELECT \n        CTE.*, \n        CASE    \n            WHEN [Member Grade] IN ('Member', 'Senior Member', 'Fellow', 'Honorary Fellow') THEN 'Professional'    \n            WHEN [Member Grade] = 'Associate' AND [Billing Grade] IN (    \n                '1 - Continuing', '3 - Full Fee', '5 - Life Member',    \n                '2 - PPP Full Fee', '3 - Full Fee', '17 - PPP MOU2',    \n                '8 - Retired'  \n            ) THEN 'Full Fee Associates'    \n            WHEN [Member Grade] NOT IN ('Member', 'Senior Member', 'Fellow', 'Honorary Fellow', 'Subscriber', 'Honorary Member')    \n                AND [Billing Grade] IN (    \n                    '4 - Graduate - 1st Year', '7 - Graduate - 2nd Year',    \n                    '10 - Student - PPP', '11 - Student',    \n                    '15 - Student - ACSF', '16 - Unemployed / On Hiatus'    \n                ) THEN 'Discounted (Full Benefits)'    \n            WHEN [Member Grade] NOT IN ('Member', 'Senior Member', 'Fellow', 'Honorary Fellow', 'Subscriber', 'Honorary Member')   \n                AND [Billing Grade] IN ('20 - Skills Applicant') THEN 'Skills Applicants'  \n            WHEN [Member Grade] NOT IN ('Member', 'Senior Member', 'Fellow', 'Honorary Fellow', 'Subscriber', 'Honorary Member')  \n                AND [Billing Grade] IN ('11 - Complimentary', '12 - Complimentary', '13 - Honoured') THEN 'Complimentary (Full Benefits)'  \n            WHEN [Member Grade] NOT IN ('Member', 'Senior Member', 'Fellow', 'Honorary Fellow', 'Subscriber', 'Honorary Member')  \n                AND [Billing Grade] IN ('14 - Student - PYear') THEN 'Professional Year'  \n            WHEN [Member Grade] NOT IN ('Member', 'Senior Member', 'Fellow', 'Honorary Fellow', 'Subscriber', 'Honorary Member')   \n                AND [Billing Grade] IN (\n                    '18 - Digital Subscriber', '19 - Subscriber - PPP', '18 - Subscriber - PPP'    \n                ) THEN 'Subscribers (Discounted Limited Benefits)'\n            ELSE NULL -- Set Heirarchy to NULL if none of the conditions are met\n        END AS Heirarchy\n    FROM CTE\n), \nCTE2 \nAs (\n\nSELECT *, \n    CASE  \n        WHEN [Heirarchy] = 'Professional' AND [Billing Grade] NOT IN ('5 - Life Member', '13 - Honoured', '1 - Continuing', '8 - Retired', '3 - Full Fee', '2 - PPP Full Fee', '17 - PPP MOU2', '16 - PPP MOU2') \n\t\tTHEN 'Member, Senior Member, Fellow'  \n   \n        WHEN [Heirarchy] = 'Professional' AND [Billing Grade] IN ('5 - Life Member', '13 - Honoured', '1 - Continuing') THEN 'Life Members, Hon Members'        \n        WHEN [Heirarchy] = 'Professional' AND [Billing Grade] = '3 - Full Fee' THEN 'Full Fee (Individual)'        \n        WHEN [Heirarchy] = 'Professional' AND [Billing Grade] IN ('2 - PPP Full Fee', '17 - PPP MOU2', '16 - PPP MOU2') THEN 'Full Fee (PPP)'        \n        WHEN [Heirarchy] = 'Professional' AND [Billing Grade] = '8 - Retired' THEN 'Retired'        \n  \n            \n        WHEN [Heirarchy] = 'Full Fee Associates' AND [Billing Grade] IN ('3 - Full Fee', '5 - Life Member', '1 - Continuing') THEN 'Full Fee Associates (Individual)'        \n        WHEN [Heirarchy] = 'Full Fee Associates' AND [Billing Grade] IN ('2 - PPP Full Fee', '17 - PPP MOU2', '16 - PPP MOU2') THEN 'Full Fee Associates (PPP)'        \n       WHEN [Heirarchy] = 'Full Fee Associates' AND [Billing Grade] = '8 - Retired' THEN 'Retired'     \n              \n        WHEN [Heirarchy] = 'Discounted\u000b(Full Benefits)' AND [Billing Grade] IN ('10 - Student - PPP', '11 - Student', '15 - Student - ACSF') THEN 'Students'        \n        WHEN [Heirarchy] = 'Discounted\u000b(Full Benefits)' AND [Billing Grade] IN ('4 - Graduate - 1st Year', '7 - Graduate - 2nd Year') THEN 'Graduate'        \n        WHEN [Heirarchy] = 'Discounted\u000b(Full Benefits)' AND [Billing Grade] = '16 - Unemployed / On Hiatus' THEN 'Unemployed'   \n  \n            \n        WHEN [Heirarchy] = 'Subscribers (Discounted Limited Benefits)' AND [Billing Grade] NOT IN ('19 - Subscriber - PPP', '18 - Subscriber - PPP') THEN 'Individuals'        \n        WHEN [Heirarchy] = 'Subscribers (Discounted Limited Benefits)' AND [Billing Grade] IN ('19 - Subscriber - PPP', '18 - Subscriber - PPP') THEN 'PPP'        \n        WHEN [Heirarchy] = 'Professional Year' THEN 'Professional Year'        \n        WHEN [Heirarchy] = 'Complimentary (Full Benefits)' THEN 'Complimentary'        \n        --WHEN [BGG] = 'Overseas' AND [Heirarchy] != 'Professional' THEN 'Skills Applicants'        \n        WHEN [Heirarchy] = 'Skills Applicants' THEN 'Skills Applicants'        \n        --WHEN ([subsegments] = 'Full Fee Associates (PPP)' OR [subsegments] = 'Full Fee Associates (Individual)') THEN 'Full Fee Associates'      \n    END as subsegments\nFROM CTE1)\nselect * from CTE2\n",
						"queryTimeout": "02:00:00",
						"partitionOption": "None"
					},
					"sink": {
						"type": "AzureSqlSink",
						"preCopyScript": "delete from  [membership].[dashboard_category] where \nMonthdate = @{pipeline().parameters.Month}\nand category ='New'",
						"writeBehavior": "insert",
						"sqlWriterUseTableLock": false,
						"disableMetricsCollection": false
					},
					"enableStaging": false,
					"translator": {
						"type": "TabularTranslator",
						"typeConversion": true,
						"typeConversionSettings": {
							"allowDataTruncation": true,
							"treatBooleanAsNumber": false
						}
					}
				},
				"inputs": [
					{
						"referenceName": "AzureSQLSP",
						"type": "DatasetReference"
					}
				],
				"outputs": [
					{
						"referenceName": "SQLTableQ",
						"type": "DatasetReference",
						"parameters": {
							"tablename": "dashboard_category",
							"schemaname": "membership"
						}
					}
				]
			}
		],
		"parameters": {
			"Month": {
				"type": "string",
				"defaultValue": "'2024-01-31'"
			}
		},
		"folder": {
			"name": "ACS/Membership"
		},
		"annotations": []
	}
}